name: Collect Info

on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: macos-latest
    timeout-minutes: 360

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          check-latest: true

      - name: Install CUTEst via custom script
        shell: bash
        run: |
          set -euo pipefail
          chmod +x ./install_cutest_mac.sh
          ./install_cutest_mac.sh

      - name: Install PyCUTEst
        shell: bash
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip
          python -m pip install pycutest

      - name: Checkout OptiProfiler
        uses: actions/checkout@v4
        with:
          repository: optiprofiler/optiprofiler
          path: optiprofiler
          submodules: recursive
          ref: python

      - name: Install Python dependencies
        shell: bash
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Resolve CUTEst env from Homebrew (with compatibility shim)
        shell: bash
        run: |
          set -euo pipefail
          # 关闭匿名统计（可选；参考 Homebrew 文档）
          export HOMEBREW_NO_ANALYTICS=1

          # 1) 定位前缀
          CUTEST_PREFIX="$(brew --prefix cutest 2>/dev/null || true)"
          SIFDECODE_PREFIX="$(brew --prefix sifdecode 2>/dev/null || true)"
          MASTSIF_PREFIX="$(brew --prefix mastsif 2>/dev/null || true)"

          if [ -z "$CUTEST_PREFIX" ]; then
            echo "cutest not found; installing..."
            brew tap optimizers/cutest
            brew install cutest
            CUTEST_PREFIX="$(brew --prefix cutest)"
          fi
          CUTEST_PATH="$CUTEST_PREFIX"  # Homebrew 的 opt 路径
          if [ ! -d "$CUTEST_PATH/lib" ]; then
            echo "CUTEST lib directory not found under $CUTEST_PATH"
            exit 1
          fi

          # 2) SIFDECODE/MASTSIF 路径
          SIFDECODE_PATH=""
          [ -n "$SIFDECODE_PREFIX" ] && [ -d "$SIFDECODE_PREFIX/share/sifdecode" ] && SIFDECODE_PATH="$SIFDECODE_PREFIX/share/sifdecode"
          MASTSIF_PATH=""
          [ -n "$MASTSIF_PREFIX" ] && [ -d "$MASTSIF_PREFIX/share/mastsif" ] && MASTSIF_PATH="$MASTSIF_PREFIX/share/mastsif"

          # 3) 兼容层：若 CUTEST/lib 下没有任何子目录，则创建一个，并链接到 double 精度库
          has_subdir="$(find "$CUTEST_PATH/lib" -mindepth 1 -maxdepth 1 -type d | head -n1 || true)"
          MYARCH_VALUE=""
          if [ -z "$has_subdir" ]; then
            compat_dir="$CUTEST_PATH/lib/homebrew"
            mkdir -p "$compat_dir"
            # 选择 double 精度作为默认
            if [ -f "$CUTEST_PATH/lib/libcutest_double.dylib" ]; then
              ln -sfn ../libcutest_double.dylib "$compat_dir/libcutest.dylib"
            fi
            if [ -f "$CUTEST_PATH/lib/libcutest_double.a" ]; then
              ln -sfn ../libcutest_double.a "$compat_dir/libcutest.a"
            fi
            # 兜底：若 double 不存在，尝试 single
            if [ ! -e "$compat_dir/libcutest.dylib" ] && [ -f "$CUTEST_PATH/lib/libcutest_single.dylib" ]; then
              ln -sfn ../libcutest_single.dylib "$compat_dir/libcutest.dylib"
            fi
            if [ ! -e "$compat_dir/libcutest.a" ] && [ -f "$CUTEST_PATH/lib/libcutest_single.a" ]; then
              ln -sfn ../libcutest_single.a "$compat_dir/libcutest.a"
            fi

            # 校验
            if [ ! -e "$compat_dir/libcutest.dylib" ] && [ ! -e "$compat_dir/libcutest.a" ]; then
              echo "Failed to create compatibility symlinks in $compat_dir"
              ls -la "$CUTEST_PATH/lib" || true
              exit 1
            fi

            MYARCH_VALUE="homebrew"
          else
            # 若原本就有子目录，沿用第一个即可
            MYARCH_VALUE="$(basename "$has_subdir")"
          fi

          # 4) 持久化环境变量
          {
            echo "CUTEST=$CUTEST_PATH"
            [ -n "$SIFDECODE_PATH" ] && echo "SIFDECODE=$SIFDECODE_PATH"
            [ -n "$MASTSIF_PATH" ] && echo "MASTSIF=$MASTSIF_PATH"
            echo "MYARCH=$MYARCH_VALUE"
          } >> "$GITHUB_ENV"

          echo "Resolved env:"
          echo "  CUTEST=$CUTEST_PATH"
          echo "  SIFDECODE=${SIFDECODE_PATH:-<empty>}"
          echo "  MASTSIF=${MASTSIF_PATH:-<empty>}"
          echo "  MYARCH=$MYARCH_VALUE"

          # 编译期可能需要 gfortran
          if ! command -v gfortran &>/dev/null; then
            brew install gcc
          fi

      - name: Run Python script
        shell: bash
        run: |
          set -euo pipefail

          if [ -z "${CUTEST:-}" ]; then
            CUTEST_PREFIX="$(brew --prefix cutest 2>/dev/null || true)"
            if [ -n "$CUTEST_PREFIX" ]; then
              if [ -d "$CUTEST_PREFIX/lib" ]; then
                export CUTEST="$CUTEST_PREFIX"
              elif [ -d "$CUTEST_PREFIX/share/cutest/lib" ]; then
                export CUTEST="$CUTEST_PREFIX/share/cutest"
              fi
            fi
          fi

          if [ -z "${SIFDECODE:-}" ]; then
            P="$(brew --prefix sifdecode 2>/dev/null || true)"
            [ -n "$P" ] && [ -d "$P/share/sifdecode" ] && export SIFDECODE="$P/share/sifdecode"
          fi
          if [ -z "${MASTSIF:-}" ]; then
            P="$(brew --prefix mastsif 2>/dev/null || true)"
            [ -n "$P" ] && [ -d "$P/share/mastsif" ] && export MASTSIF="$P/share/mastsif"
          fi

          if [ -z "${MYARCH:-}" ] && [ -n "${CUTEST:-}" ] && [ -d "$CUTEST/lib" ]; then
            export MYARCH="$(find "$CUTEST/lib" -mindepth 1 -maxdepth 1 -type d -exec basename {} \; | head -n1 || true)"
          fi

          echo "Using CUTEST=${CUTEST:-<empty>}"
          echo "Using SIFDECODE=${SIFDECODE:-<empty>}"
          echo "Using MASTSIF=${MASTSIF:-<empty>}"
          echo "Using MYARCH=${MYARCH:-<empty>}"

          python -m p_getInfo

      - name: Debug CUTEst layout
        if: always()
        shell: bash
        run: |
          set -euo pipefail
          echo "brew --prefix cutest: $(brew --prefix cutest 2>/dev/null || echo '<none>')"
          echo "brew --cellar cutest: $(brew --cellar cutest 2>/dev/null || echo '<none>')"
          P="$(brew --prefix cutest 2>/dev/null || true)"
          if [ -n "$P" ]; then
            echo "Tree under $P (depth 2):"
            (command -v tree >/dev/null || brew install tree) && tree -L 2 "$P" || ls -R "$P" | sed -n '1,200p'
            if [ -d "$P/share/cutest" ]; then
              echo "Tree under $P/share/cutest (depth 2):"
              tree -L 2 "$P/share/cutest"
            fi
          fi
      
      - name: Upload Python artifacts
        uses: actions/upload-artifact@v4
        with:
          name: probinfo-files-pycutest
          path: |
            probinfo_pycutest.csv
            feasibility_pycutest.txt
            timeout_problems_pycutest.txt
            log_pycutest.txt