name: Collect Info

on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: macos-latest
    timeout-minutes: 360

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          check-latest: true

      - name: Install CUTEst via custom script
        shell: bash
        run: |
          set -euo pipefail
          chmod +x ./install_cutest_mac.sh
          ./install_cutest_mac.sh

      - name: Install PyCUTEst
        shell: bash
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip
          python -m pip install pycutest

      - name: Checkout OptiProfiler
        uses: actions/checkout@v4
        with:
          repository: optiprofiler/optiprofiler
          path: optiprofiler
          submodules: recursive
          ref: python

      - name: Install Python dependencies
        shell: bash
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Resolve CUTEst env from Homebrew (with full compatibility shim)
        shell: bash
        run: |
          set -euo pipefail
          export HOMEBREW_NO_ANALYTICS=1

          # 1) 定位前缀
          CUTEST_PREFIX="$(brew --prefix cutest 2>/dev/null || true)"
          SIFDECODE_PREFIX="$(brew --prefix sifdecode 2>/dev/null || true)"
          MASTSIF_PREFIX="$(brew --prefix mastsif 2>/dev/null || true)"

          if [ -z "$CUTEST_PREFIX" ]; then
            echo "cutest not found; installing..."
            brew tap optimizers/cutest
            brew install cutest
            CUTEST_PREFIX="$(brew --prefix cutest)"
          fi
          CUTEST_PATH="$CUTEST_PREFIX"
          [ -d "$CUTEST_PATH/lib" ] || { echo "CUTEST lib directory not found under $CUTEST_PATH"; exit 1; }

          # 2) SIFDECODE/MASTSIF
          SIFDECODE_PATH=""
          [ -n "$SIFDECODE_PREFIX" ] && [ -d "$SIFDECODE_PREFIX/share/sifdecode" ] && SIFDECODE_PATH="$SIFDECODE_PREFIX/share/sifdecode"
          MASTSIF_PATH=""
          [ -n "$MASTSIF_PREFIX" ] && [ -d "$MASTSIF_PREFIX/share/mastsif" ] && MASTSIF_PATH="$MASTSIF_PREFIX/share/mastsif"

          # 3) 兼容层
          MYARCH_VALUE=""
          # 若 lib 下没有任何子目录，则创建 $CUTEST/lib/homebrew 并链接 libcutest.{a,dylib}
          has_lib_subdir="$(find "$CUTEST_PATH/lib" -mindepth 1 -maxdepth 1 -type d | head -n1 || true)"
          compat_lib_dir="$CUTEST_PATH/lib/homebrew"
          if [ -z "$has_lib_subdir" ]; then
            mkdir -p "$compat_lib_dir"
            # 默认用 double 精度
            if [ -f "$CUTEST_PATH/lib/libcutest_double.dylib" ]; then
              ln -sfn ../libcutest_double.dylib "$compat_lib_dir/libcutest.dylib"
            fi
            if [ -f "$CUTEST_PATH/lib/libcutest_double.a" ]; then
              ln -sfn ../libcutest_double.a "$compat_lib_dir/libcutest.a"
            fi
            # 兜底 single
            if [ ! -e "$compat_lib_dir/libcutest.dylib" ] && [ -f "$CUTEST_PATH/lib/libcutest_single.dylib" ]; then
              ln -sfn ../libcutest_single.dylib "$compat_lib_dir/libcutest.dylib"
            fi
            if [ ! -e "$compat_lib_dir/libcutest.a" ] && [ -f "$CUTEST_PATH/lib/libcutest_single.a" ]; then
              ln -sfn ../libcutest_single.a "$compat_lib_dir/libcutest.a"
            fi
            if [ ! -e "$compat_lib_dir/libcutest.dylib" ] && [ ! -e "$compat_lib_dir/libcutest.a" ]; then
              echo "Failed to create lib compatibility symlinks in $compat_lib_dir"
              ls -la "$CUTEST_PATH/lib" || true
              exit 1
            fi
            MYARCH_VALUE="homebrew"
          else
            MYARCH_VALUE="$(basename "$has_lib_subdir")"
          fi

          # 也为 modules 建立同名子目录（很多旧版 pycutest 会检查 modules/$MYARCH）
          compat_mod_dir="$CUTEST_PATH/modules/$MYARCH_VALUE"
          if [ ! -d "$compat_mod_dir" ]; then
            mkdir -p "$compat_mod_dir"
            # 将顶层的 .mod 文件都链接进去（保留相对路径，便于 Cellar 版本更新）
            find "$CUTEST_PATH/modules" -maxdepth 1 -type f -name "*.mod" -print0 | while IFS= read -r -d '' f; do
              base="$(basename "$f")"
              ln -sfn "../$base" "$compat_mod_dir/$base"
            done
          fi

          # 可选：有些脚本也会探测 include/$MYARCH；做个软链接目录，增强兼容性（不做也多数可通过）
          compat_inc_dir="$CUTEST_PATH/include/$MYARCH_VALUE"
          if [ ! -d "$compat_inc_dir" ]; then
            mkdir -p "$compat_inc_dir"
            find "$CUTEST_PATH/include" -maxdepth 1 -type f -print0 | while IFS= read -r -d '' f; do
              base="$(basename "$f")"
              ln -sfn "../$base" "$compat_inc_dir/$base"
            done
          fi

          # 4) 持久化环境变量
          {
            echo "CUTEST=$CUTEST_PATH"
            [ -n "$SIFDECODE_PATH" ] && echo "SIFDECODE=$SIFDECODE_PATH"
            [ -n "$MASTSIF_PATH" ] && echo "MASTSIF=$MASTSIF_PATH"
            echo "MYARCH=$MYARCH_VALUE"
          } >> "$GITHUB_ENV"

          echo "Resolved env:"
          echo "  CUTEST=$CUTEST_PATH"
          echo "  SIFDECODE=${SIFDECODE_PATH:-<empty>}"
          echo "  MASTSIF=${MASTSIF_PATH:-<empty>}"
          echo "  MYARCH=$MYARCH_VALUE"
          echo "Listings for debug:"
          ls -la "$CUTEST_PATH/lib" || true
          ls -la "$CUTEST_PATH/lib/$MYARCH_VALUE" || true
          ls -la "$CUTEST_PATH/modules" || true
          ls -la "$CUTEST_PATH/modules/$MYARCH_VALUE" || true

          # gfortran（若无）
          if ! command -v gfortran &>/dev/null; then
            brew install gcc
          fi
      - name: Run Python script
        shell: bash
        run: |
          set -euo pipefail

          if [ -z "${CUTEST:-}" ]; then
            CUTEST_PREFIX="$(brew --prefix cutest 2>/dev/null || true)"
            if [ -n "$CUTEST_PREFIX" ]; then
              if [ -d "$CUTEST_PREFIX/lib" ]; then
                export CUTEST="$CUTEST_PREFIX"
              elif [ -d "$CUTEST_PREFIX/share/cutest/lib" ]; then
                export CUTEST="$CUTEST_PREFIX/share/cutest"
              fi
            fi
          fi

          if [ -z "${SIFDECODE:-}" ]; then
            P="$(brew --prefix sifdecode 2>/dev/null || true)"
            [ -n "$P" ] && [ -d "$P/share/sifdecode" ] && export SIFDECODE="$P/share/sifdecode"
          fi
          if [ -z "${MASTSIF:-}" ]; then
            P="$(brew --prefix mastsif 2>/dev/null || true)"
            [ -n "$P" ] && [ -d "$P/share/mastsif" ] && export MASTSIF="$P/share/mastsif"
          fi

          if [ -z "${MYARCH:-}" ] && [ -n "${CUTEST:-}" ] && [ -d "$CUTEST/lib" ]; then
            export MYARCH="$(find "$CUTEST/lib" -mindepth 1 -maxdepth 1 -type d -exec basename {} \; | head -n1 || true)"
          fi

          echo "Using CUTEST=${CUTEST:-<empty>}"
          echo "Using SIFDECODE=${SIFDECODE:-<empty>}"
          echo "Using MASTSIF=${MASTSIF:-<empty>}"
          echo "Using MYARCH=${MYARCH:-<empty>}"

          python -m p_getInfo

      - name: Debug CUTEst layout
        if: always()
        shell: bash
        run: |
          set -euo pipefail
          echo "brew --prefix cutest: $(brew --prefix cutest 2>/dev/null || echo '<none>')"
          echo "brew --cellar cutest: $(brew --cellar cutest 2>/dev/null || echo '<none>')"
          P="$(brew --prefix cutest 2>/dev/null || true)"
          if [ -n "$P" ]; then
            echo "Tree under $P (depth 2):"
            (command -v tree >/dev/null || brew install tree) && tree -L 2 "$P" || ls -R "$P" | sed -n '1,200p'
            if [ -d "$P/share/cutest" ]; then
              echo "Tree under $P/share/cutest (depth 2):"
              tree -L 2 "$P/share/cutest"
            fi
          fi
      
      - name: Upload Python artifacts
        uses: actions/upload-artifact@v4
        with:
          name: probinfo-files-pycutest
          path: |
            probinfo_pycutest.csv
            feasibility_pycutest.txt
            timeout_problems_pycutest.txt
            log_pycutest.txt